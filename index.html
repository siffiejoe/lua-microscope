<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>microscope -- Visualizing Complex Lua Values Using GraphViz</title>
	<link rel="stylesheet" type="text/css" href="default.css" />
<link rel="stylesheet" type="text/css" href="highlight.css" /><script type="text/javascript" src="highlight.pack.js"></script><script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script></head>
<body>

<p><img src="logo.png" alt="project logo" /></p><h1>microscope -- Visualizing Complex Lua Values Using GraphViz</h1><div class="toc"><a href="#Introduction" title="Introduction">Introduction</a> · <a href="#Basic_Usage" title="Basic Usage">Basic Usage</a> · <a href="#Reference" title="Reference">Reference</a> · <a href="#Download" title="Download">Download</a> · <a href="#Installation" title="Installation">Installation</a> · <a href="#Changes" title="Changes">Changes</a> · <a href="#Contact" title="Contact">Contact</a> · <a href="#License" title="License">License</a></div>

<h2><a name="Introduction" id="Introduction"></a>Introduction</h2>

<p>Checking the value of a Lua variable during debugging is often
invaluable and <code>print()</code> is a commonly used debugging tool. But what
about complex table values? Many Lua programmers have written their
own pretty-printer or data dumper and some even use it for
(de-)serializing Lua data structures. But this seems to reach its
limit when one takes cyclic references, metatables, upvalues and
environment tables into account.</p>

<p>This module dumps arbitrarily complex Lua values as <a href="http://www.graphviz.org/" title="GraphViz Homepage">GraphViz</a>
.dot-files that can be transformed into a variety of image formats.</p>



<h2><a name="Basic_Usage" id="Basic_Usage"></a>Basic Usage</h2>

<p>Somewhere in your Lua scripts require this module and call the result,
passing a file name and the value to be inspected:</p>

<pre><code>$ cat &gt; test.lua
local up1 = false
local up2 = io.stdout
local t1 = { val = 1 }
local t2 = { val = 2 }
setmetatable( t1, { __index = function( t, k )
  if t2[ k ] ~= nil then
    return t2[ k ]
  else
    return up1 or up2
  end
end } )
setmetatable( t2, { __index = t1 } )

require( "microscope" )( "example1.dot", t1 )
^D
</code></pre>

<p>Run the script and convert the resulting .dot file to a nice image:</p>

<pre><code class="no-highlight">$ lua test.lua
$ dot -T gif -o example1.gif example1.dot
</code></pre>

<p>This results in:</p>

<p><img src="example1.gif" alt="example1" /></p>


<h2><a name="Reference" id="Reference"></a>Reference</h2>

<p>The function returned from the <code>require</code>-call takes two mandatory
arguments:</p>

<ol>
    <li>a file name (typically a .dot file) or an output function</li>
    <li>a Lua value to show</li>
</ol>

<p>After those two arguments, a number of optional arguments can be given
(in any order):</p>

<ul>
    <li><p>a number</p>
    
    <p>This limits the number of linked values to display. <code>1</code> means
    only the passed Lua value itself, <code>2</code> means the value itself and
    any value that can be reached in 1 step, and so on. Default is <code>0</code>
    which means to follow all links.</p></li>
    <li><p>any table, userdata, function or thread</p>
    
    <p>Prunes the resulting graph at the given value. Typical use cases
    are the <code>microscope</code> function itself, <code>package.loaded</code> or even
    <code>_G</code>.</p></li>
    <li><p><code>"html"</code>, <code>"nohtml"</code></p>
    
    <p>Enables/disables the generation of HTML code in the .dot files.
    HTML code is used for prettier tables, but older GraphViz versions
    cannot handle HTML. If you see strange code in your images, try
    the <code>"nohtml"</code>-option. Default is <code>"html"</code>.</p></li>
    <li><p><code>"environments"</code>, <code>"noenvironments"</code></p>
    
    <p>Enables/disables display of environment tables. Most functions
    share the global environment and the pictures get quite big, so
    the default is <code>"noenvironments"</code>.</p></li>
    <li><p><code>"upvalues"</code>, <code>"noupvalues"</code></p>
    
    <p>Enables/disables display of upvalues for functions. Default is
    <code>"upvalues"</code>.</p></li>
    <li><p><code>"metatables"</code>, <code>"nometatables"</code></p>
    
    <p>Enables/disables display of metatables for tables/userdata.
    Default is <code>"metatables"</code>.</p></li>
    <li><p><code>"leaves"</code>, <code>"noleaves"</code></p>
    
    <p>Sometimes (when a value is part of a table and does not have any
    outgoing links), it is unnecessary to draw an extra shape for this
    value, as it would clutter the image. This option enables/disables
    the generation of leaf nodes in the graph. Default is
    <code>"noleaves"</code>.</p></li>
    <li><p><code>"locals"</code>, <code>"nolocals"</code></p>
    
    <p>Enables/disables display of a table-like stack with local
    variables for all suspended and active coroutines. If no coroutine
    is active, the main stack is displayed as well. Default is
    <code>"nolocals"</code>. All settings that limit graph node output also apply
    to the references in the stack(s).</p></li>
    <li><p><code>"registry"</code>, <code>"noregistry"</code></p>
    
    <p>Enables/disables display of the Lua registry table. The registry
    is included as another root node in the graph output. Default is
    <code>"noregistry"</code>. All settings that limit graph node output also
    apply to the references in the registry.</p></li>
    <li><p><code>"sizes"</code>, <code>"nosizes"</code></p>
    
    <p>If <a href="http://code.matthewwild.co.uk/lua-getsize/">lua-getsize</a> is available in <code>package.cpath</code>, the size of a
    table, userdata, thread, and function will be added to the label
    automatically. This setting enables/disables the creation of extra
    nodes in the graph also showing the object's size. The default is
    <code>"nosizes"</code>.</p></li>
    <li><p>any other string</p>
    
    <p>Any other string is used as a label for the graph. If multiple
    labels are given, only the last one is used.</p></li>
</ul>

<p>The output function (if used as first argument) takes one argument and
should write its argument and a trailing newline to wherever you want
(the <code>print</code>-function is compatible).</p>



<h3>Examples</h3>

<p>Showing (custom) environment tables:</p>

<pre><code>local t1 = { val = 1 }
local t2 = { 1, 2, 3, val = 2 }
setmetatable( t1, { __index = t2 } )
local function f1()
  print( val, t2.val )
end
setfenv( f1, t1 )

require( "microscope" )( "example2.dot", f1, "environments" )
</code></pre>

<p>Leads to:</p>

<p><img src="example2.gif" alt="example2" /></p>

<p>Limiting displayed elements:</p>

<pre><code>local t = { { { { { {} } } } } }

local todot = require( "microscope" )
todot( "example3.dot", t )
todot( "example4.dot", t, 3 )
</code></pre>

<p>Leads to:</p>

<p><img src="example3.gif" alt="example3" /> and <img src="example4.gif" alt="example4" /></p>

<p>Showing leaf nodes in the graph:</p>

<pre><code>local function f1() end
local function f2()
  return f2()
end
local t1 = { func1 = f1, func2 = f2 }
local t2 = { func1 = f1 }
local t = { t1, t2, {} }

local todot = require( "microscope" )
todot( "example5.dot", t )
todot( "example6.dot", t, "leaves" )
</code></pre>

<p>Leads to:</p>

<p><img src="example5.gif" alt="example5" /> and <img src="example6.gif" alt="example6" /></p>


<h2><a name="Download" id="Download"></a>Download</h2>

<p>The source code (with documentation and test scripts) is available on
<a href="https://github.com/siffiejoe/lua-microscope/">github</a>.</p>



<h2><a name="Installation" id="Installation"></a>Installation</h2>

<p>There are two ways to install this module, either using luarocks (if
this module already is in the <a href="http://luarocks.org/repositories/rocks/" title="Main Repository">main luarocks repository</a>) or
manually.</p>

<p>Using luarocks, simply type:</p>

<pre><code>luarocks install microscope
</code></pre>

<p>To install the module manually just drop the Lua file <code>microscope.lua</code>
somewhere into your Lua <code>package.path</code>.</p>



<h2><a name="Changes" id="Changes"></a>Changes</h2>

<p>Version 0.4:</p>

<ul>
    <li>Compatibility with Lua 5.3</li>
    <li>Show objects' sizes if <a href="http://code.matthewwild.co.uk/lua-getsize/">lua-getsize</a> is available.</li>
    <li>Protect from errors in <code>__tostring</code> metamethods</li>
</ul>

<p>Version 0.3:</p>

<ul>
    <li>Fixed long labels from <code>__tostring</code> metamethods.</li>
    <li>Support for LuaJIT's <code>cdata</code> values.</li>
</ul>

<p>Version 0.2:</p>

<ul>
    <li>First public release.</li>
</ul>


<h2><a name="Contact" id="Contact"></a>Contact</h2>

<p>Philipp Janda, siffiejoe(a)gmx.net</p>

<p>Comments and feedback are always welcome.</p>


<h2><a name="License" id="License"></a>License</h2>

<p><code>microscope</code> is <em>copyrighted free software</em> distributed under the MIT
license (the same license as Lua 5.1). The full license text follows:</p>

<pre><code class="no-highlight">microscope (c) 2013-2014 Philipp Janda

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHOR OR COPYRIGHT HOLDER BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
</code></pre>



</body></html>
